user  www-data;
worker_processes auto;

events {
    worker_connections  4096;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;
    error_log   /var/log/nginx/error.log warn;

    sendfile       on;
    tcp_nopush     on;
    tcp_nodelay    on;
    keepalive_timeout  65;
    types_hash_max_size 2048;

    # Cloudflare real IPs
    set_real_ip_from 127.0.0.0/8;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 131.0.72.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 2400:cb00::/32;
    set_real_ip_from 2606:4700::/32;
    set_real_ip_from 2803:f800::/32;
    set_real_ip_from 2405:b500::/32;
    set_real_ip_from 2405:8100::/32;
    set_real_ip_from 2a06:98c0::/29;
    set_real_ip_from 2c0f:f248::/32;

    real_ip_header X-Forwarded-For;

    # ==============================
    # Main server (80/443)
    # ==============================
    server {
        listen 80;
        listen [::]:80;
        listen 443 ssl http2 reuseport;
        listen [::]:443 ssl http2 reuseport;

        server_name *.xxxxxx;

        ssl_certificate     /etc/xray/xray.crt;
        ssl_certificate_key /etc/xray/xray.key;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        root /home/vps/public_html;

        # VLESS WS
        location /vless {
            proxy_redirect off;
            proxy_pass http://127.0.0.1:14016;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # VMESS WS
        location /vmess {
            proxy_redirect off;
            proxy_pass http://127.0.0.1:23456;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # TROJAN WS
        location /trws {
            proxy_redirect off;
            proxy_pass http://127.0.0.1:25432;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # SHADOWSOCKS WS
        location /ssws {
            proxy_redirect off;
            proxy_pass http://127.0.0.1:30300;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # Fallback (root)
        location / {
            proxy_redirect off;
            proxy_pass http://127.0.0.1:700;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # VLESS gRPC
        location /vless-grpc {
            if ($content_type !~ "^application/grpc") { return 404; }
            client_max_body_size 0;
            grpc_set_header X-Real-IP $remote_addr;
            grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            grpc_set_header Host $host;
            grpc_pass grpc://127.0.0.1:24456;
        }

        # VMESS gRPC
        location /vmess-grpc {
            if ($content_type !~ "^application/grpc") { return 404; }
            client_max_body_size 0;
            grpc_set_header X-Real-IP $remote_addr;
            grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            grpc_set_header Host $host;
            grpc_pass grpc://127.0.0.1:31234;
        }

        # TROJAN gRPC
        location /trojan-grpc {
            if ($content_type !~ "^application/grpc") { return 404; }
            client_max_body_size 0;
            grpc_set_header X-Real-IP $remote_addr;
            grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            grpc_set_header Host $host;
            grpc_pass grpc://127.0.0.1:33456;
        }

        # SS gRPC
        location /ss-grpc {
            if ($content_type !~ "^application/grpc") { return 404; }
            client_max_body_size 0;
            grpc_set_header X-Real-IP $remote_addr;
            grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            grpc_set_header Host $host;
            grpc_pass grpc://127.0.0.1:30310;
        }
    }

    # ==============================
    # VLESS (2086/2087)
    # ==============================
    server {
        listen 2086;
        listen [::]:2086;
        listen 2087 ssl http2 reuseport;
        listen [::]:2087 ssl http2 reuseport;

        server_name *.xxxxxx;

        ssl_certificate     /etc/xray/xray.crt;
        ssl_certificate_key /etc/xray/xray.key;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        location / {
            proxy_redirect off;
            proxy_pass http://127.0.0.1:2024;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }

    # ==============================
    # VMESS (2082/2083)
    # ==============================
    server {
        listen 2082;
        listen [::]:2082;
        listen 2083 ssl http2 reuseport;
        listen [::]:2083 ssl http2 reuseport;

        server_name *.xxxxxx;

        ssl_certificate     /etc/xray/xray.crt;
        ssl_certificate_key /etc/xray/xray.key;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        location / {
            proxy_redirect off;
            proxy_pass http://127.0.0.1:2025;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }

    # ==============================
    # Panel (2081)
    # ==============================
    server {
        listen 2081 ssl;
        server_name xxxxxx;

        ssl_certificate     /etc/xray/xray.crt;
        ssl_certificate_key /etc/xray/xray.key;

        access_log /var/log/nginx/vps-access.log;
        error_log  /var/log/nginx/vps-error.log error;

        root /home/vps/public_html;

        location / {
            index index.html index.htm index.php;
            try_files $uri $uri/ /index.php?$args;
        }

        error_page 400 401 402 403 404 405 406 407 408 409 410
                   411 412 413 414 415 416 417 418 421 422 423 424 425 426 428 429
                   431 451
                   500 501 502 503 504 505 506 507 508 510 511
                   = @error_redirect;

        location @error_redirect {
            return 302 https://xxxxxx:2081/;
        }

        location ~ \.php$ {
            include /etc/nginx/fastcgi_params;
            fastcgi_pass 127.0.0.1:9000;   # atau pakai unix socket sesuai PHP-FPM kamu
            fastcgi_index index.php;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        }
    }
}
